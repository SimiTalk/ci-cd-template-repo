name: SonarQube Scan (Maven)

on:
  workflow_call:
    inputs:
      java_version:
        required: false
        type: string
        default: "17"
      distribution:
        required: false
        type: string
        default: "temurin"
      sonar_project_key:
        required: true
        type: string
      sonar_project_name:
        required: true
        type: string
      maven_args:
        required: false
        type: string
        default: "-B -U -DskipTests"
    secrets:
      SONAR_TOKEN:
        required: true
      SONAR_HOST_URL:
        required: true

jobs:
  sonar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 推荐：setup-java 自带 cache:maven，比单独 cache 更省事
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: ${{ inputs.distribution }}
          cache: maven

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Build & Sonar Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          mvn ${{ inputs.maven_args }} verify \
            org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.host.url="${SONAR_HOST_URL}" \
            -Dsonar.login="${SONAR_TOKEN}" \
            -Dsonar.projectKey="${{ inputs.sonar_project_key }}" \
            -Dsonar.projectName="${{ inputs.sonar_project_name }}"